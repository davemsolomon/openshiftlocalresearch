
## Find out which images i need to mirror:
> oc get packagemanifest ${target} -o yaml | grep -A 4 relatedImages
      relatedImages:
      - icr.io/cpopen/t8c-operator@sha256:cece0c92925a79b4b624a333b46e4db5cdf0a7d0bab8b06376d07c34628689e9
      - registry.connect.redhat.com/turbonomic/t8c-operator-bundle@sha256:75627e532f7df351f7e74267ca4bcf7eadd5f7cdadb5863fb256726419d4d9a2
      version: 42.86.0-beta.1

podman login ghcr.io
Username: davemsolomon
Password:
Login Succeeded!

podman login registry.connect.redhat.com
Username: davemsolomon114
Password: 
Login Succeeded!

podman pull registry.connect.redhat.com/turbonomic/t8c-operator-bundle@sha256:75627e532f7df351f7e74267ca4bcf7eadd5f7cdadb5863fb256726419d4d9a2

podman tag registry.connect.redhat.com/turbonomic/t8c-operator-bundle@sha256:75627e532f7df351f7e74267ca4bcf7eadd5f7cdadb5863fb256726419d4d9a2 ghcr.io/davemsolomon/t8c-operator-bundle:latest
podman push ghcr.io/davemsolomon/t8c-operator-bundle:latest

go here to make the package public but also here is the interesting question,
did the sha stay the same when i pushed the image up to ghcr.io...?
this is what the following website says the sha is - sha256:75627e532f7df351f7e74267ca4bcf7eadd5f7cdadb5863fb256726419d4d9a2 - it does match!!!
https://github.com/users/davemsolomon/packages/container/package/t8c-operator-bundle

## Do the block
## turbo_block.yml
apiVersion: config.openshift.io/v1
kind: Image
metadata:
  name: cluster
spec:
  registrySources:
    blockedRegistries:
    - "registry.connect.redhat.com/turbonomic"
  additionalTrustedCA:
    name: ""

## implement a mirror
## turbo_mirror.yml
apiVersion: operator.openshift.io/v1alpha1
kind: ImageContentSourcePolicy
metadata:
  name: turbo-mirror
spec:
  repositoryDigestMirrors:
  - mirrors:
    - ghcr.io/davemsolomon
    source: registry.connect.redhat.com/turbonomic

> oc run test-mirror-turbo --image=registry.connect.redhat.com/turbonomic/t8c-operator-bundle@sha256:75627e532f7df351f7e74267ca4bcf7eadd5f7cdadb5863fb256726419d4d9a2

> oc get pod test-mirror-turbo
NAME                READY   STATUS             RESTARTS   AGE
test-mirror-turbo   0/1     ImagePullBackOff   0          15s

> oc get pod test-mirror-turbo -o yaml
    state:
      waiting:
        message: 'Back-off pulling image "registry.connect.redhat.com/turbonomic/t8c-operator-bundle@sha256:75627e532f7df351f7e74267ca4bcf7eadd5f7cdadb5863fb256726419d4d9a2":
          ErrImagePull: initializing source docker://registry.connect.redhat.com/turbonomic/t8c-operator-bundle@sha256:75627e532f7df351f7e74267ca4bcf7eadd5f7cdadb5863fb256726419d4d9a2:
          registry registry.connect.redhat.com/turbonomic is blocked in /etc/containers/registries.conf

crc stop
crc start

     waiting:
        message: 'Back-off pulling image "registry.connect.redhat.com/turbonomic/t8c-operator-bundle@sha256:75627e532f7df351f7e74267ca4bcf7eadd5f7cdadb5863fb256726419d4d9a2":
          SignatureValidationFailed: image pull failed for registry.connect.redhat.com/turbonomic/t8c-operator-bundle@sha256:75627e532f7df351f7e74267ca4bcf7eadd5f7cdadb5863fb256726419d4d9a2
          because the signature validation failed: Source image rejected: Running
          image docker://registry.connect.redhat.com/turbonomic/t8c-operator-bundle@sha256:75627e532f7df351f7e74267ca4bcf7eadd5f7cdadb5863fb256726419d4d9a2
          is rejected by policy.'

https://access.redhat.com/solutions/7006404
Root Cause
In a disconnected environment the cluster cannot verify the images signatures, so they must be provided.

because I am getting this signaturevalidationfailed messsage it was unclear if the signature validation was failing after it grabbed the mirrored image so
I messed up the checksum on purpose on an image pull because I expected that i would get a mirror failed message and I was correct, so it is safe to say that the signature validation failed message comes after the block is working and after the mirror is working...
> oc run test-mirror-turbo-bad-sha --image=registry.connect.redhat.com/turbonomic/t8c-operator-bundle@sha256:75627e532f7df351f7e74267ca4bcf7eadd5f7cdadb5863fb256726419d4d9ab
pod/test-mirror-turbo-bad-sha created

> oc get pod test-mirror-turbo-bad-sha -o yaml
      waiting:
        message: 'initializing source docker://registry.connect.redhat.com/turbonomic/t8c-operator-bundle@sha256:75627e532f7df351f7e74267ca4bcf7eadd5f7cdadb5863fb256726419d4d9ab:
          (Mirrors also failed: [ghcr.io/davemsolomon/t8c-operator-bundle@sha256:75627e532f7df351f7e74267ca4bcf7eadd5f7cdadb5863fb256726419d4d9ab:
          reading manifest sha256:75627e532f7df351f7e74267ca4bcf7eadd5f7cdadb5863fb256726419d4d9ab
          in ghcr.io/davemsolomon/t8c-operator-bundle: manifest unknown]): registry.connect.redhat.com/turbonomic/t8c-operator-bundle@sha256:75627e532f7df351f7e74267ca4bcf7eadd5f7cdadb5863fb256726419d4d9ab:
          registry registry.connect.redhat.com/turbonomic is blocked in /etc/containers/registries.conf


in an attempt to see if i could get the "signature" to copy, i deleted the image out of the ghcr.io registry
and then recreated it using skopeo copy

skopeo copy docker://registry.connect.redhat.com/turbonomic/t8c-operator-bundle@sha256:75627e532f7df351f7e74267ca4bcf7eadd5f7cdadb5863fb256726419d4d9a2 docker://ghcr.io/davemsolomon/t8c-operator-bundle:latest
Getting image source signatures
Copying blob dc28e765db35 skipped: already exists  
Copying config 6c062f8f24 done   | 
Writing manifest to image destination
